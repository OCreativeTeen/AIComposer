# 视频拖拽替换功能

## 功能概述

在视频生成标签页中新增了拖拽功能，允许用户通过拖拽MP4文件来替换当前场景的视频片段。

## 功能特性

### 1. 拖拽支持
- 支持拖拽以下视频格式：`.mp4`, `.avi`, `.mov`, `.mkv`, `.wmv`
- 拖拽目标：视频预览画布
- 视觉反馈：拖拽时会显示蓝色边框

### 2. 时长验证
- **输入视频时长 > 目标时长**：❌ 拒绝替换，显示错误信息
- **输入视频时长 ≤ 目标时长**：✅ 允许替换

### 3. 自动延长功能
当输入视频较短时，系统会自动延长视频到目标时长：
- 保持输入视频的最后一帧直到匹配目标时长
- 如果视频包含音频，会相应延长音频（填充静音）
- 如果视频没有音频，只延长视频轨道

## 使用方法

### 前提条件
1. 确保已安装 `tkinterdnd2` 包：`pip install tkinterdnd2`
2. 项目已生成脚本和场景数据
3. 已在视频标签页中刷新场景列表

### 操作步骤
1. 切换到"生成视频"标签页
2. 点击"刷新视频列表"加载场景数据
3. 使用导航按钮选择要替换的场景
4. 将MP4文件拖拽到视频预览画布上
5. 系统会自动验证时长并处理替换

## 技术实现

### 新增的方法

#### FFmpeg处理器 (`utility/ffmeg_processor.py`)
```python
def extend_video_to_duration(input_video_path, target_duration, output_video_path)
```
- 用于延长视频到目标时长
- 支持有音频和无音频的视频
- 使用FFmpeg的`tpad`滤镜来克隆最后一帧

#### GUI处理器 (`magic_workflow_gui.py`)
```python
def on_video_drop(event)                    # 处理视频拖拽事件
def handle_video_replacement(source_path)   # 处理视频替换逻辑
def get_current_video_scene_duration()   # 获取当前场景时长
def is_video_file(file_path)               # 验证视频文件格式
```

## 错误处理

### 常见错误及解决方案

1. **"输入视频时长超过目标时长"**
   - 原因：输入视频比场景要求的时长更长
   - 解决：使用视频编辑软件裁剪视频，或选择其他更短的视频

2. **"没有加载视频场景数据"**
   - 原因：未加载场景列表
   - 解决：点击"刷新视频列表"按钮

3. **"无法获取当前场景时长信息"**
   - 原因：场景数据缺失或损坏
   - 解决：重新生成脚本或检查场景JSON文件

4. **"视频延长失败"**
   - 原因：FFmpeg处理出错
   - 解决：检查输入视频格式，确保FFmpeg正确安装

## 支持的视频格式

- **输入格式**：MP4, AVI, MOV, MKV, WMV
- **输出格式**：MP4 (H.264编码)
- **分辨率**：自动缩放到1280x720
- **音频**：AAC编码，192kbps

## 注意事项

1. 替换的视频会保存在项目的`temp`文件夹中
2. 文件命名格式：`{场景索引:03d}.mp4`（例如：`000.mp4`, `001.mp4`）
3. 延长视频时可能需要较长处理时间，取决于视频大小和延长时长
4. 建议使用H.264编码的MP4文件以获得最佳兼容性

## 界面提示

- 空白画布：显示拖拽提示和使用说明
- 有视频时：在视频下方显示拖拽提示
- 拖拽悬停：显示蓝色边框视觉反馈
- 成功替换：显示成功对话框和详细信息 