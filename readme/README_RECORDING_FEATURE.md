# 录音功能说明

## 概述

在 `gui/media_review_dialog.py` 中新增了录音功能，允许用户直接从麦克风录音并设置为源音频进行后续处理。

## 实现完成

✅ **录音按钮集成**: 在媒体控制面板中添加了"录音"按钮  
✅ **录音对话框**: 创建了专门的录音界面，显示录音状态和时间  
✅ **音频录制**: 使用sounddevice库实现高质量音频录制  
✅ **自动转录**: 录音完成后自动调用Whisper进行语音转录  
✅ **JSON更新**: 转录结果自动更新到Fresh JSON和Audio JSON编辑器  
✅ **源音频替换**: 录音文件自动设置为source_audio_path  
✅ **重新生成标志**: 自动设置audio_regenerated = True  
✅ **依赖管理**: 添加了sounddevice和soundfile到requirements.txt  
✅ **错误处理**: 完善的错误处理和用户友好的提示  
✅ **资源清理**: 正确的内存和文件资源管理

## 功能特性

### 录音能力
- **麦克风录音**: 支持从默认麦克风设备录音
- **实时显示**: 录音过程中显示录音时间
- **音频质量**: 44.1kHz采样率，单声道录音
- **音频格式**: 保存为WAV格式，便于后续处理

### 集成功能
- **自动设置源音频**: 录音完成后自动设置为 `source_audio_path`
- **自动转录**: 录音完成后自动调用Whisper进行转录
- **JSON更新**: 转录结果自动更新到Fresh JSON和Audio JSON编辑器
- **重新生成标志**: 自动设置 `audio_regenerated = True`

## 安装依赖

在使用录音功能前，需要安装以下依赖：

```bash
pip install sounddevice soundfile
```

或者使用项目的requirements.txt：

```bash
pip install -r requirements.txt
```

## 使用方法

### 开始录音
1. 在媒体预览对话框中点击"录音"按钮
2. 弹出录音对话框，显示"正在录音..."
3. 可以看到实时的录音时间显示

### 停止录音
1. 点击"停止录音"按钮
2. 录音会自动保存为临时WAV文件
3. 系统会自动：
   - 设置录音文件为源音频
   - 更新时间选择器范围
   - 重新绘制音频波形
   - 转录音频内容
   - 更新JSON编辑器

### 录音后处理
- 录音文件会替代原有的源音频文件
- 可以使用所有音频处理功能（播放、剪切、转录等）
- 转录结果会显示在JSON编辑器中
- 可以进一步编辑和处理音频内容

## 技术实现

### 核心组件
- **sounddevice**: 用于音频录制
- **soundfile**: 用于音频文件保存
- **numpy**: 用于音频数据处理
- **threading**: 用于录音后台线程

### 错误处理
- 依赖库缺失检查
- 录音设备可用性检查
- 录音过程异常处理
- 文件保存错误处理

### 资源管理
- 自动清理临时录音文件
- 录音对话框生命周期管理
- 线程安全的录音状态管理

## 注意事项

1. **权限要求**: 需要麦克风访问权限
2. **音频设备**: 需要可用的音频输入设备
3. **依赖安装**: 确保安装了sounddevice和soundfile库
4. **存储空间**: 录音会创建临时文件，确保有足够存储空间
5. **转录质量**: 录音质量会影响后续转录准确性

## 集成说明

录音功能完全集成到现有的媒体预览对话框中：
- 符合现有的UI设计风格
- 遵循现有的错误处理模式
- 与现有的音频处理流程兼容
- 保持与其他功能的一致性

录音完成后，所有现有的音频处理功能都可以正常使用，包括播放、剪切、转录、JSON编辑等。
