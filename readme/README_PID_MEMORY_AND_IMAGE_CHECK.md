# 魔法工作流GUI - PID记忆和图像检查功能

## 新增功能概述

本次更新为魔法工作流GUI添加了两个重要功能：
1. **PID记忆功能** - 自动保存和加载上次使用的项目配置
2. **图像检查功能** - 智能检查和显示现有的场景图像

## 1. PID记忆功能

### 功能描述
- 自动保存当前的项目ID（PID）、语言和频道设置
- 下次启动GUI时自动加载上次保存的配置
- 生成按钮可以覆盖保存的PID

### 实现细节
- **配置文件**: `magic_workflow_gui_config.json`
- **保存时机**: 
  - PID输入框内容变化时
  - 点击"自动生成PID"按钮时
  - 关闭GUI窗口时
- **加载时机**: GUI启动时

### 配置文件格式
```json
{
  "pid": "20241201_1500",
  "language": "zh",
  "channel": "strange_zh"
}
```

### 使用方式
1. 正常使用GUI，输入或生成PID
2. 配置会自动保存
3. 下次启动GUI时，上次的配置会自动恢复
4. 可以通过"自动生成PID"按钮生成新的PID并覆盖保存的设置

## 2. 图像检查功能

### 功能描述
- 检查项目文件夹中是否已存在场景图像
- 智能显示现有图像或提示图像缺失
- 支持生成或重新生成图像（无论图像是否已存在）

### 实现细节
- **图像路径**: `{magic_workflow.project_path}/{场景索引}.webp`
- **检查时机**: 
  - 点击"刷新列表"按钮时
  - 切换场景时
  - 生成图像后

### 新增显示信息
- **项目路径**: 显示当前项目的完整路径
- **图像统计**: 显示"X个已存在, Y个缺失"的统计信息
- **场景状态**: 显示每个场景的图像加载状态和文件大小
- **智能提示**: 
  - 图像存在时显示图像和文件信息
  - 图像不存在时显示提示信息："图像文件不存在\n点击'保存并生成/重新生成图像'来创建"

### 按钮改进
- **按钮文本**: 从"保存并重新生成图像"改为"保存并生成/重新生成图像"
- **按钮状态**: 当有场景数据时总是启用（无论图像是否存在）
- **功能**: 可以生成新图像或重新生成现有图像

## 技术改进

### GUI改进 (`magic_workflow_gui.py`)

#### 新增方法
1. **`load_config()`** - 加载保存的配置
2. **`save_config()`** - 保存当前配置
3. **`on_closing()`** - 处理窗口关闭事件
4. **`check_existing_images(workflow)`** - 检查现有图像并显示统计

#### 修改的方法
1. **`__init__()`** - 添加配置文件管理和窗口关闭事件绑定
2. **`generate_auto_pid()`** - 添加配置保存
3. **`on_pid_change()`** - 添加配置保存
4. **`refresh_scenarios()`** - 添加项目路径显示和图像检查
5. **`load_scenario_image()`** - 使用项目路径，添加详细状态信息
6. **`update_scenario_display()`** - 修改按钮状态逻辑
7. **`bind_edit_events()`** - 简化，因为按钮现在总是可用

### 用户体验改进

#### 更直观的界面
- 显示项目路径信息
- 显示图像存在状态统计
- 提供清晰的操作提示

#### 更智能的操作
- 自动记忆上次工作配置
- 智能检测现有图像
- 灵活的图像生成/重新生成

#### 更详细的反馈
- 图像加载状态和文件大小信息
- 操作成功/失败的详细日志
- 清晰的错误提示和建议

## 使用流程

### 首次使用
1. 启动GUI（使用默认设置）
2. 设置PID、语言和频道
3. 配置自动保存

### 后续使用
1. 启动GUI（自动加载上次配置）
2. 可以继续使用上次的项目，或生成新的PID
3. 在图像标签页中点击"刷新列表"查看现有图像状态

### 图像管理
1. 点击"刷新列表"查看项目图像状态
2. 使用导航按钮浏览不同场景
3. 编辑场景信息
4. 点击"保存并生成/重新生成图像"处理单个场景
5. 使用"为所有场景生成图像"批量生成

## 文件结构

### 配置文件
```
magic_workflow_gui_config.json  # GUI配置文件（PID、语言、频道）
```

### 项目文件
```
/Projects/Channel/media/program/data/{PID}/
├── 0.webp                     # 场景0的图像
├── 1.webp                     # 场景1的图像
└── ...                        # 其他场景图像

/Projects/Channel/media/program/publish/
├── {PID}.json                 # 段落数据文件
├── {PID}.srt                  # 字幕文件
└── {PID}_scenarios.json       # 场景索引文件
```

## 注意事项

1. **配置文件**: 会在GUI工作目录下自动创建，不需要手动管理
2. **项目路径**: 确保对项目目录有读写权限
3. **图像格式**: 目前支持WebP格式的场景图像
4. **兼容性**: 新功能向后兼容，不影响现有工作流

## 测试

运行测试脚本验证功能：
```bash
python test_pid_memory_and_image_check.py
```

测试覆盖：
- PID记忆功能的保存和加载
- 图像检查功能的路径验证
- GUI新方法的存在性验证
- 配置文件的读写功能 