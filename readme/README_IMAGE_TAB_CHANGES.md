# 魔法工作流GUI - 图像生成标签页重构

## 概述

本次重构完全重新设计了图像生成标签页，提供了更强大和用户友好的功能来管理和生成场景图像。

## 新增功能

### 1. 批量图像生成
- **按钮**: "为所有场景生成图像"
- **功能**: 为`magic_workflow.py`中`self.paragraphs`（由`generate_summary()`生成）的所有场景批量生成图像
- **使用**: 确保已先运行"生成摘要"，然后点击此按钮为所有场景生成图像

### 2. 图像预览和导航
- **图像显示区域**: 左侧显示当前场景的图像（400x300像素）
- **导航按钮**: 
  - "◀ 上一个" - 切换到上一个场景
  - "下一个 ▶" - 切换到下一个场景
- **场景计数器**: 显示"场景: X / Y"格式的当前位置
- **刷新按钮**: "刷新列表" - 重新加载段落数据

### 3. 场景信息编辑
右侧编辑面板包含以下可编辑字段：
- **开始时间** (只读): 显示场景的时间戳
- **摘要**: 多行文本框，用于编辑场景的详细描述
- **背景**: 多行文本框，用于编辑环境描述
- **对象或角色**: 多行文本框，用于编辑人物或物体信息
- **动作**: 多行文本框，用于编辑动作或情感描述
- **风格**: 多行文本框，用于编辑光影和风格信息

### 4. 实时保存和重新生成
- **保存按钮**: "保存并重新生成图像" - 默认禁用
- **自动启用**: 当任何字段被编辑时，按钮自动启用
- **功能**: 
  - 保存当前场景的修改到`self.paragraphs`
  - 将更新保存到JSON文件
  - 重新生成当前场景的图像
  - 自动刷新图像显示

### 5. 操作日志
- 底部日志区域显示所有操作的详细信息
- 包括时间戳的操作记录
- 成功和错误信息的清晰显示

## 技术改进

### 后端方法重构 (`magic_workflow.py`)

新增以下方法：

1. **`create_image_for_scene(scene_data, scene_index, previous_scene, description="")`**
   - 为单个场景生成图像
   - 支持前一个场景作为参考以保持连续性
   - 支持自定义描述

2. **`create_images(description="")`**
   - 为所有场景批量生成图像
   - 返回生成的场景列表

3. **`save_paragraphs()`**
   - 保存段落数据到JSON文件

4. **`load_paragraphs()`**
   - 从JSON文件加载段落数据

5. **`get_scene_by_index(scene_index)`**
   - 根据索引获取场景数据和位置信息

6. **`update_scene(scene_index, updated_scene)`**
   - 更新指定索引的场景数据（保持start_time不变）

7. **`get_total_scenes_count()`**
   - 获取总场景数量

### GUI改进 (`magic_workflow_gui.py`)

1. **线程安全**: 使用`self.root.after()`确保GUI更新在主线程中执行
2. **实时编辑检测**: 绑定键盘事件来检测内容变化
3. **图像处理**: 使用PIL库进行图像加载和缩放
4. **状态管理**: 维护当前场景索引和工作流状态

## 使用流程

1. **准备数据**: 
   - 设置项目ID、语言和频道
   - 先运行"生成摘要"来创建段落数据

2. **生成图像**:
   - 在"生成图像"标签页中
   - 输入描述（可选）
   - 点击"为所有场景生成图像"

3. **浏览和编辑**:
   - 点击"刷新列表"加载场景数据
   - 使用导航按钮浏览不同场景
   - 在右侧编辑面板修改场景信息

4. **更新特定场景**:
   - 编辑场景信息后，"保存并重新生成图像"按钮将启用
   - 点击按钮保存修改并重新生成该场景的图像

## 文件结构

生成的图像保存在：
```
/Projects/Channel/media/program/data/{PID}/{场景索引}.webp
```

段落数据保存在：
```
/Projects/Channel/media/program/publish/{PID}.json
```

场景索引文件保存在：
```
/Projects/Channel/media/program/publish/{PID}_scenes.json
```

## 测试

运行`test_gui_changes.py`来验证所有功能是否正常工作：

```bash
python test_gui_changes.py
```

## 注意事项

1. 确保已安装PIL库：`pip install Pillow`
2. 图像生成需要稳定扩散服务正在运行
3. 编辑场景信息时，`start_time`字段不能被修改
4. 所有操作都是异步的，可在"任务状态"标签页查看进度 